name: Build & Publish (dotnet CLI, .NET 10)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      PROJECT_PATH: TrayScreenshotApp.csproj
      CONFIGURATION: Release
      RUNTIME: win-x64
      PUBLISH_DIR: artifacts/publish

      # Pass secrets into the job environment (no `if:` expressions that reference `secrets.*`)
      # NOTE: These are optional. If they are empty/missing, the signing step will be skipped.
      PFX_B64: ${{ secrets.Base64_Encoded_Pfx }}
      PFX_PASSWORD: ${{ secrets.Pfx_Key }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET SDK (preview)
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'
          include-prerelease: true

      - name: Show .NET info
        run: dotnet --info

      - name: Restore
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build
        run: dotnet build "${{ env.PROJECT_PATH }}" --configuration "${{ env.CONFIGURATION }}" --no-restore

      - name: Publish
        run: >
          dotnet publish "${{ env.PROJECT_PATH }}"
          --configuration "${{ env.CONFIGURATION }}"
          --runtime "${{ env.RUNTIME }}"
          --no-build
          --output "${{ env.PUBLISH_DIR }}"

      # Optional: Authenticode-sign the produced .exe using a PFX stored as GitHub secrets.
      # This is NOT MSIX/ClickOnce signing. It signs the EXE(s) in the publish folder.
      - name: Decode PFX and sign published EXE(s)
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:PFX_B64) -or [string]::IsNullOrWhiteSpace($env:PFX_PASSWORD)) {
            Write-Host "Signing secrets not provided. Skipping Authenticode signing."
            exit 0
          }

          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          try {
            $pfxBytes = [Convert]::FromBase64String($env:PFX_B64)
            [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)

            $exeFiles = Get-ChildItem -Path "${{ env.PUBLISH_DIR }}" -Filter *.exe -Recurse
            if (-not $exeFiles) { throw "No .exe found under '${{ env.PUBLISH_DIR }}' to sign." }

            foreach ($f in $exeFiles) {
              signtool sign `
                /f "$pfxPath" `
                /p "$env:PFX_PASSWORD" `
                /fd SHA256 `
                /tr "http://timestamp.digicert.com" `
                /td SHA256 `
                "$($f.FullName)"
            }

            Write-Host "Signing complete."
          }
          finally {
            if (Test-Path $pfxPath) { Remove-Item -Path $pfxPath -Force }
          }

      - name: Upload published app
        uses: actions/upload-artifact@v6
        with:
          name: TrayScreenshotApp-${{ env.RUNTIME }}
          path: ${{ env.PUBLISH_DIR }}
