name: Build & Publish (dotnet CLI, .NET 10)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      PROJECT_PATH: TrayScreenshotApp.csproj
      CONFIGURATION: Release
      RUNTIME: win-x64
      PUBLISH_DIR: artifacts/publish

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET SDK (preview)
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'
          include-prerelease: true

      - name: Show .NET info
        run: dotnet --info

      - name: Restore
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build
        run: dotnet build "${{ env.PROJECT_PATH }}" --configuration "${{ env.CONFIGURATION }}" --no-restore

      - name: Publish
        run: >
          dotnet publish "${{ env.PROJECT_PATH }}"
          --configuration "${{ env.CONFIGURATION }}"
          --runtime "${{ env.RUNTIME }}"
          --no-build
          --output "${{ env.PUBLISH_DIR }}"

      # Optional: Authenticode-sign the produced .exe using a PFX stored as GitHub secrets.
      # This is NOT MSIX/ClickOnce signing; it signs the executable(s) in the publish folder.
      - name: Decode signing certificate (PFX)
        if: ${{ secrets.Base64_Encoded_Pfx != '' && secrets.Pfx_Key != '' }}
        shell: pwsh
        run: |
          $pfxBytes = [Convert]::FromBase64String("${{ secrets.Base64_Encoded_Pfx }}")
          $pfxPath  = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Sign published EXE(s)
        if: ${{ env.PFX_PATH != '' }}
        shell: pwsh
        run: |
          $exeFiles = Get-ChildItem -Path "${{ env.PUBLISH_DIR }}" -Filter *.exe -Recurse
          if (-not $exeFiles) { throw "No .exe found under ${{ env.PUBLISH_DIR }} to sign." }

          foreach ($f in $exeFiles) {
            # Uses SignTool from the Windows SDK (typically present on GitHub-hosted Windows runners).
            signtool sign `
              /f "$env:PFX_PATH" `
              /p "${{ secrets.Pfx_Key }}" `
              /fd SHA256 `
              /tr "http://timestamp.digicert.com" `
              /td SHA256 `
              "$($f.FullName)"
          }

      - name: Remove PFX from runner
        if: ${{ env.PFX_PATH != '' }}
        shell: pwsh
        run: Remove-Item -Path "$env:PFX_PATH" -Force

      - name: Upload published app
        uses: actions/upload-artifact@v6
        with:
          name: TrayScreenshotApp-${{ env.RUNTIME }}
          path: ${{ env.PUBLISH_DIR }}
